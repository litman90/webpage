{"title":"Queen's Gambit","markdown":{"yaml":{"title":"Queen's Gambit","subtitle":"A trip down the chess rabbit hole","date":"2021-02-07","categories":["chess","fun","design"],"code-fold":true},"headingText":"Too Long ‚Äî Didn't Read","containsRefs":false,"markdown":"\n\nI love games. I enjoy the fun in many formats: cards, boards, consoles.\nYet, over the years, chess has consolidated as the game I play most often, and it is likely the only game I both **really** like and can limit the amount I play[^1].\n\n[^1]: However, after reading this post you might believe I'm a bit of a\n    chess junkie üòù\n\nIt's been a couple of months since I noticed something weird going on in my games, a sort of disturbance in the force. I felt I was playing a type of position called **Queen's Gambit** way more often than normal. \n\nBecause there's currently a sort of chess mania fueled by the very successful new series that gets the name from the gambit[^2], I thought it would be pretty easy to find out whether the data reflected my gut feeling.\n\n[^2]: But mostly because the star is a kick-ass woman.\n\n\nI apologize for writing long posts. Be my guest and jump directly to the popularity of the Queen's Gambit across time by clicking [here](#popularity)\n\n## The data\n\nTo do any sort of analysis, I needed data. Although there are probably many places where I could have found it, `www.chess.com` has a large dataset and it is somewhat accessible (if you can parse websites, see [how](#more-readings)). It is also the place where I play, so the dataset of *my* games comes from there. \n\nThroughout this post, I will be using two datasets:\n\n1) Master Games: games played by Chess Masters where Queen's Gambit is played.\n2) My games: All my games at chess.com, spanning from 2012 to January 2021.\n\nLet's minimally explore the dataset of Master Games for the sake of DataViz üìà.\n\n```{r}\n#| label: setup\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(tidyverse, warn.conflicts = F)\n# read previous datasets\ndf <- read_csv(\"./queens_gambit/queen_gambit.csv\")\nmy_games <- read_csv(\"./queens_gambit/chess_games/my_games_UNPUBLISHED.csv\")\n\n# add text result to the data\ndf <- \ndf %>% \n  mutate(text_result = case_when(Result == \"1-0\" ~ \"white wins\",\n                                 Result == \"0-1\" ~ \"black wins\",\n                                 TRUE ~ \"draw\"),\n         text_result = factor(text_result, \n                              levels = c(\"white wins\", \"draw\", \"black wins\"))) \n\ngeneral_caption <- \"Source: chess.com\\nViz: @NeuroMLA\"\n\n```\n\nI first started looking at a dataset with `r nrow(df)` entries, from games played between chess Masters (aka Master Games) that open with Queen's Gambit. Games were played between `r min(df$Year)` and `r max(df$Year)`. After a bit of data cleaning, there were a few quick things I wanted to look at.\n\nBelow, you can find a violin plot of the number of moves a chess match between masters normally has.\n\n```{r}\n#| echo: false\n \ndf %>% \n  ggplot(aes(text_result, Moves, fill=text_result)) +\n  geom_violin()+\n  stat_summary(fun.data = mean_se,\n               show.legend = F,\n               color=\"#bbb4a9ff\")+\n  scale_y_continuous(breaks=seq(0,200,40))+\n  ggthemes::theme_fivethirtyeight() +\n  theme(plot.title = element_text(hjust = 0.5)) +\n  scale_fill_manual(values = c(\"white\", \"#777574ff\", \"black\"))+\n  labs(fill = \"\",\n       title = \"Chess Master Games last around 40 moves\",\n       caption = general_caption)\n \n```\n\nIf you are curious, here's a table with summary statistics for the number of moves in the games by result.\n\n```{r}\n#| label: table-results\n#| warning: !expr F\n#| message: !expr F\n#| echo: !expr F\ntibble_summary <- function(x){\n  summary(x) %>% \n    as.matrix() %>% \n    t() %>% \n    as_tibble() %>% \n    janitor::clean_names() %>% \n    rename(q25 = x1st_qu,\n           q75 = x3rd_qu)\n}\n  \ndt <-   \ndf %>% \n  group_by(text_result) %>% \n  summarise(y=list(tibble_summary(Moves))) %>% \n  unnest(y) %>% \n  rename(Result = text_result) %>%\n  mutate_if(is.numeric, ~round(., digits=2)) \n\ndt %>% \n  gt::gt()\n\n# data table not rendering right now\n#dt %>% \n#  DT::datatable(options = list(dom = 't'))\n```\n\n\n```{r}\n#| label: data-clean\n#| echo: !expr F\n#| warning: !expr F\n#| message: !expr F\nclean_df <- \ndf %>%\n  mutate(Players=str_squish(Players)) %>% \n  separate(Players, into=c(\"Players\", \"moves\"), sep=\" 1. \") %>%\n  separate(moves, into=c(\"moves\", \"accepted\"), sep = \" Queen's Gambit\") %>%\n  separate(accepted, into=c(\"accepted\", \"variation\"), sep=\": \") %>% \n  separate(moves, into = c(\"first\", \"second\", \"third\"), sep=\" [2-3]\\\\. \")\n\n# a few ones need further cleaning\nclean_df <- \n  clean_df %>% \n  filter(accepted != \"\") %>% \n  filter(!str_detect(string = accepted, pattern = \" Declined with.\")) %>% \n  mutate(Result = factor(Result, levels = c(\"1-0\", \"¬Ω-¬Ω\", \"0-1\")))\n\n```\n\n## What is this \"Queen's Gambit\", anyway?\n\nGenerally speaking, a gambit is a position where both players stand to exchange pieces. In the particular case of the **Queen's Gambit**, we are most often referring to this position (although see further below).\n\n```{r}\n#| out.width: 50%\n#| out.height: 50%\n#| echo: !expr F\n#| fig.align: center\nknitr::include_graphics(\"./queens_gambit/boards/board01.png\")\n```\n\n## When does it happen?\n\nQueen's gambit is an opening, this means it occurs early in the game. In this case, the gambit is overwhelmingly proposed on the second move and just a few games develop into a position that is equivalent to the Queen's gambit later in the game.\n\n```{r}\n#| echo: !expr F\nclean_df %>% \n  count(second = str_detect(second, \"^c4\"),\n        third = str_detect(third, \"^c4\")) %>%\n  mutate(proposal = factor(c(\"later\", \"third move\", \"second move\"),\n                           levels = c(\"second move\", \"third move\", \"later\"))) %>%\n  ggplot() +\n  geom_col(aes(proposal, n)) +\n  geom_text(aes(proposal, n - n/10, label=n), vjust = -0.5) +\n  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale()))+\n  ggthemes::theme_fivethirtyeight() +\n  labs(title=\"Games with Queen's Gambit proposal\",\n       subtitle = \"Counting games with proposal on 2nd move, 3rd move, or afterwards\",\n       caption = general_caption)\n\n```\n\n## Who benefits?\n\nIn chess, whoever starts (aka plays white) has advantage. However, Chess Masters are heavily trained in defense, so it's not a walk in the part for white. It always depends heavily on the initial positions (openings), gambit proposals, and responses (accepted or declined with many variations). In the case of the Queen's Gambit, the machines predict white is favorite to win, while accepting the gambit increases the likelihood of draws. Interestingly, if we calculate the expected value for black from the observed frequencies, it might be slightly better for black to accept the gambit[^3].\n\n[^3]: I'm using the observed frequencies and calculating one point per     win and 0.5 points per draw. This gives the expected values for each     player.\n\n```{r}\n#| label: barplots-patch\n#| message: !expr F\n#| echo: !expr F\nprop_df <- \nclean_df %>% \n  count(accepted, text_result) %>% \n  group_by(accepted) %>% \n  mutate(total = sum(n),\n         prop = n/total,\n         pos = 1 - cumsum(prop) + prop/2)\n# barplot\nprop_plot <-\nprop_df %>% \n  ggplot()+ \n  geom_col(aes(accepted, prop, fill = text_result), color=\"black\") +\n  geom_text(aes(accepted, pos, label = scales::percent(prop, accuracy = 1L)),\n            color=\"#bbb4a9ff\", size=12) +\n  scale_fill_manual(values = c(\"white\", \"#777574ff\", \"black\"))+\n  ggthemes::theme_fivethirtyeight(base_size = 16) +\n  labs(fill= \"\",\n       title=\"Accepting Queen's Gambit: better for black?\",\n       subtitle=\"Proportion of Master Games\") +\n  coord_flip()\n\n# expected_win\nexpected_game_value <-\nprop_df %>% \n  group_by(accepted) %>% \n  summarise(expected_white = \n              0.5 * prop[text_result==\"draw\"] + \n              1 * prop[text_result==\"white wins\"],\n            expected_black = \n              0.5 * prop[text_result==\"draw\"] + \n              1 * prop[text_result==\"black wins\"]\n              ) %>% \n  pivot_longer(-accepted) %>%\n  mutate(name = str_remove(name, \"expected_\")) %>% \n  group_by(accepted) %>% \n  mutate(pos = ifelse(name==\"black\",\n                      1 - value/2,\n                      value - value/2)) %>% \n  ggplot(aes(accepted, value, fill=name))+\n  geom_col(color=\"black\") +\n  geom_text(aes(accepted, pos,\n                label= round(value, 2)),\n            hjust = 0.5, \n            color=\"#bbb4a9ff\", size=12)+\n  coord_flip()+\n  scale_fill_manual(values=c(\"black\", \"white\"))+\n  ggthemes::theme_fivethirtyeight(base_size = 16)+\n  labs(subtitle=\"Expected Game Value (based on observed proportions)\",\n       fill=\"\",\n       caption = general_caption) \n\nlibrary(patchwork)\nbars_together <- \nprop_plot / expected_game_value +\n  plot_layout(nrow=2, widths = c(1.5,1)) #+\n  #plot_annotation()\n\n# I cannot figure out how to do the proper ggsave here. doing it manually\n# ggsave(plot = bars_together, filename = \"./queens_gambit/bars_together.png\", width=8, height=4)\n\n```\n\n\n```{r}\n#| label: bars-together-plot\n#| echo: false\n#| out.width: 80%\n#| out.height: 80%\nknitr::include_graphics(\"./queens_gambit/bars_together.png\")\n\n```\n\n\nI wouldn't treat this tiny increment as something real. It is likely just noise. In reality, Chess Masters decline the Queen's gambit way more often than they accept it (about\n`r clean_df %>% count(accepted) %>% summarise(prop=round(last(n)/first(n), 2)) %>% pull(prop)` times more often!). \n\nIn fact, if we check with the chess engines, they seldom accept the Queen's Gambit either. On a personal, totally amateur note, I don't feel like accepting the Queen's Gambit, it just doesn't feel right.\n\n## Where do they go?\n\nAfter the opening, chess games branch into a myriad possible positions. I believe a cool way to see this is to use alluvial plots to visualize how the games evolve in time. It would really be a mess to visualize all moves, so I just focused on certain games and kept it short around proposal/response in regards to Queen's Gambit. I added the result of the game, just out of curiosity.\n\n```{r}\n#| label: alluvial\n#| message: !expr F\n#| warning: !expr F\n#| echo: !expr F\nlibrary(ggalluvial)\nclean_df %>% \n  mutate(first = paste(\"1.\", first, \"\\n2. c4\"),\n         second = str_remove(second, \"c4 \")) %>% \n  # remove \"Nf3 Nf6\" so we only focus on the gambit on the first two moves\n  filter(second != \"Nf3 Nf6\") %>% \n  # lump the moves \n  mutate(first = fct_lump_min(factor(first), min = 1500),\n         second = fct_lump_min(factor(second), min = 1000),\n         third = fct_lump_min(factor(third), min = 1000)) %>%\n  # remove first == \"other\"\n  filter(first != \"Other\") %>% \n  group_by(accepted) %>%  \n  count(first, second, third, text_result) %>% \nggplot(aes(axis1 = first, axis2 = second, axis3 = third, axis4=text_result,\n           y = n)) +\n  scale_x_discrete(limits = c(\"White moves c4\", \"Black's\\nResponse\", \"Third\\nMove\", \"Result\"),\n                   expand = c(0.1, 0.1)) +\n  geom_alluvium(aes(fill=accepted), width = 0.5) +\n  geom_stratum(width=0.5, alpha=0) +\n  geom_text(stat = \"stratum\", \n            aes(label = after_stat(stratum)), fontface = \"bold\")+\n  ggthemes::theme_fivethirtyeight() +\n  theme(legend.position = \"bottom\",\n        axis.text.y = element_blank(),\n        panel.grid.major = element_blank(),\n        plot.title = element_text(hjust=0.5)) +\n  scale_fill_brewer(palette = \"Set1\") +\n  labs(title=\"Flow of Master Chess Games After Queen's Gambit\",\n       fill=\"Queen's Gambit\",\n       caption= general_caption)\n\n\n```\n\nAs you can see, I focused on the two cases where white moves their pawn\nto c4 (`c4`) to actually \"propose\" the gambit. This is how both\nsituations look on the board.\n\n|           1\\. d4 d5 2. c4                                             |                1\\. d4 Nf3 2. c4                                            |\n|:-------------------------------------------------------------:|:-------------------------------------------------------------:|\n| <img src=\"./queens_gambit/boards/board01.png\" width=\"180\"/> | <img src=\"./queens_gambit/boards/board02.png\" width=\"180\"/> |\n\n\"Accepting\" the gambit means taking the pawn at c4 (`dxc4`). As we said before, this is the least frequent case, and it is interesting to see that almost none of the `Nf6` games go to accept the gambit. It's also quite telling that the vast majority of Masters respond to Queen's Gambit with `e6`. This is how it looks in the board.\n\n\n|                      1\\. d4 d5 2. c4 e6                      |                         1. d4 Nf6 2. c4 e6                       |\n|:------------------------------------------------------------:|:----------------------------------------------------------------:|\n| <img src=\"./queens_gambit/boards/board_e6.png\" width=\"180\"/> | <img src=\"./queens_gambit/boards/board_Nf6_e6.png\" width=\"180\"/> |\n\n### Special case\n\nThere's a special case where games take a bit longer to reach the gambit.  These are the games where the second move is `Nf3 Nf6`. I made the same alluvial plot for these games. For some reason, this position prompts the majority of Chess Masters to accept the gambit.\n\nThus, if you like to play the gambit as white, and you like the other side to accept it, you should delay your `c4` advance just one move.\n\n```{r}\n#| message: !expr F\n#| warning: !expr F\n#| echo: !expr F\nclean_df %>% \n  # get \"Nf3 Nf6\" \n  filter(second == \"Nf3 Nf6\") %>% \n  mutate(first = fct_lump_min(factor(first), min = 200),\n         second = fct_lump_min(factor(second), min = 1000),\n         third = fct_lump_min(factor(third), min = 200)) %>%\n  # remove first == \"other\"\n  #filter(first != \"Other\") %>% \n  group_by(accepted) %>%  \n  count(first, second, third, text_result) %>% \n  ggplot(aes(axis1 = first, axis2 = second, axis3 = third, axis4=text_result,\n             y = n)) +\n  scale_x_discrete(limits = c(\"First\\nMove\", \"Second\\nMove\", \"Third\\nMove\", \"Result\"),\n                   expand = c(0.1, 0.1)) +\n  geom_alluvium(aes(fill=accepted), width = 0.5) +\n  geom_stratum(width=0.5, alpha=0) +\n  geom_text(stat = \"stratum\", \n            aes(label = after_stat(stratum)), fontface = \"bold\")+\n  ggthemes::theme_fivethirtyeight() +\n  scale_fill_brewer(palette = \"Set1\") +\n  labs(title=\"Flow of Master Chess Games After Queen's Gambit\",\n       subtitle=\"Only showing games where `2. Nf3 Nf6` was second move\",\n       fill=\"Queen's Gambit\",\n       caption=\"Source: chess.com | Viz: @NeuroMLA\")+\n  theme(legend.position = \"bottom\",\n        axis.text.y = element_blank(),\n        panel.grid.major = element_blank(),\n        plot.title = element_text(hjust=0.5),\n        plot.subtitle = element_text(hjust=0.5)) \n\n```\n\nThis is how your board should look like if you want black to accept the gambit.\n\n\n```{r}\n#| out.width: 50%\n#| out.height: 50%\n#| echo: !expr F\n#| fig.align: center\nknitr::include_graphics(\"./queens_gambit/boards/board_second_move_accept.png\")\n```\n\n\n## Popularity\n\nEnough with the chess lingo, show me what I came here for! Alright, alright, don't bark. Here's the popularity plot on the Masters Games.\n\n```{r}\n#| label: pop-plot-masters\n#| echo: !expr F\nclean_df %>% \n  count(Year) %>% ggplot(aes(Year, n))+ \n  ggthemes::theme_fivethirtyeight()+\n  geom_line(lwd=1) +\n  geom_point(size=3) +\n  labs(title = \"Frequency of Queen's Gambit Games\",\n       subtitle=\"Data from Chess Masters\",\n        caption = general_caption)\n\n\n```\n\nThis plot shows that the popularity of the gambit increased dramatically. But my prediction was *wrong*, the gambit was super popular a few years ago and I didn't notice anything.\n\nWhat happened between 2017 and 2019? I don't really know if the total amount of games just skyrocketed, but it's possible. Maybe the 2018 world championship had something to do with it. I didn't parse the full database, so I can't tell you about the frequency of all games. \n\nWhat happened in 2020? If you are from the future, I would like to remind you that there was a Global Pandemic on 2020, stay safe whenever you are.\n\nThe popularity graph didn't show what I was expecting to see, but I still trust my gut feeling. It all started just a few months ago, I'm pretty sure that there is something in the data that needs to be unmasked. \n\nData from 2020 will not reflect my gut feeling easily. First, the pandemic messed up with the tournament schedule. Second, the TV series might be super popular with normal people, but we shouldn't expect Chess Masters to change the way they open games because of it. \n\nSo...what about simple mortals like you and me? Well, my friend, if you made it this far, I trust you to go on with my game database.\n\n## My games\n\nFirst, you should know that I *mostly* play blitz games (either 3 minutes in the clock at start or 3 minutes with 2 seconds added per move). Nonetheless, it looks like the move distribution of games is quite similar to what we see in Masters games.\n\n```{r}\n#| label: density_plot\n#| echo: !expr F\ndensity_plot_for_arrows <-\nggplot() +\n  geom_density(data = my_games,\n               aes(NMoves, fill = \"My Games\"), alpha=0.8)+\n  geom_density(data=df,\n               aes(Moves, fill = \"Master Games\"), alpha=0.8)+\n    see::scale_fill_material()+\n    ggthemes::theme_fivethirtyeight()+\n    theme(#axis.text.y = element_blank(),\n          axis.title = element_text())+\n    labs(fill=\"\", \n         y=\"Game Frequency\", \n         x = \"Moves per game\",\n         title = \"\",\n         caption = general_caption)\n\ndensity_plot_for_arrows\n```\n\nThere are two places where I see differences. First, Master Games show a bump quite early, even below 20 moves. This is unusual because it takes more moves to break a good defense. We will come back later to this.\n\n```{r}\n#| label: first-arrow\n#| echo: !expr F\ndensity_plot_for_arrows +\n  annotate(\n    geom = \"curve\", x = -0.1, y = 0.02, xend = 5, yend = 0.01, \n    curvature = .05, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"label\", x = 2, y = 0.022,\n           label = \"1\")\n```\n\nSecond, there is another bump on longer games. I attribute this to the nature of my skill level. I can't play much more than an opening and a few attempts on the \"middle game\". Most of my games will evolve pretty quickly (either because the clock forces you to be aggressive or because our chess level is not good). It's often the case that one player makes a crucial mistake and the game evolves fast after that.\n\n```{r}\n#| label: second-arrow\n#| echo: false\ndensity_plot_for_arrows +\n  annotate(\n    geom = \"curve\", x = 100, y = 0.01, xend = 80, yend = 0.005, \n    curvature = .1, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"label\", x = 105, y = 0.01,\n           label = \"2\")\n\n```\n\nThere's another explanation for these differences. If we separate games according to result. We see that Masters games have almost the same shape as mine but, when they get to a draw, they get to it really fast. For us novices, getting a draw is often an accident. Masters deliberately draw, and they do it early.\n\n```{r}\n#| label: facet-result\n#| echo: !expr F\n# add results\nmy_games <- my_games %>% \n  mutate(text_result = case_when(Result == \"1-0\" ~ \"white wins\",\n                                 Result == \"0-1\" ~ \"black wins\", TRUE ~ \"draw\"),\n         text_result = factor(text_result, levels = c(\"white wins\", \"draw\", \"black wins\")))\n\n# add years\nmy_games <- my_games %>%\n  mutate(Date = lubridate::as_date(Date),\n         year = lubridate::year(Date))\n\n# most typical variations\n#clean_df %>% count(variation, sort = T)\n\nbind_rows(select(clean_df, Moves, text_result) %>%\n            mutate(source = \"Masters Games\"),\n          select(my_games, Moves = NMoves, text_result) %>%\n            mutate(source = \"My Games\")) %>% \n  ggplot()+\n  geom_density(aes(Moves, fill=source), alpha=0.8)+\n  facet_wrap(~text_result)+ \n  see::scale_fill_material()+ \n  ggthemes::theme_fivethirtyeight()+ \n  theme(axis.text.y = element_blank(), axis.title = element_text())+ \n  labs(fill=\"\", y=\"Game Frequency\", \n       x = \"Moves per game\", \n       title = \"Master Games get into draws much faster\", \n       caption = general_caption)\n\n\n\n```\n\n### Drawing is a signal of quality\n\nAt my level, drawing a game is not common. For pros, it's quite the opposite. Something else that draws my attention is that black is really unlikely to win a game. This is similar to other games, like tennis, where the player that serves (aka, starts the game) has a huge advantage.\n\n```{r}\n#| label: result-prop\n#| echo: false\n# Result proportions\n\nbind_rows( clean_df %>% count(text_result) %>% \n             mutate(prop = n/sum(n), source = \"Master Games\"), \n           my_games %>% count(text_result) %>% \n             mutate(prop = n/sum(n), source = \"My Games\") ) %>% \n  ggplot(aes(text_result, prop, fill=source))+ \n  geom_col(position=\"dodge\", alpha=0.8)+ \n  scale_y_continuous(labels=scales::label_percent())+ \n  scale_fill_brewer(palette = \"Set1\", direction = -1)+ \n  ggthemes::theme_fivethirtyeight()+ \n  theme(axis.title = element_text())+ \n  labs(fill=\"\", y=\"Game Frequency\", \n       x=\"\",\n       title = \"Master Games get into draws more often\", \n       caption = general_caption)\n\n```\n\n### My openings\n\nIn my database, I have all the games I played. Up to February 2021, it was a total of `r nrow(my_games)`. Yes, I know, a lot, roughly `r round(nrow(my_games)/(max(my_games$year) - min(my_games$year)) / 365, 2)` per day since `r min(my_games$year)`. Anyway, I can get all the openings from my games.\n\nI selected the ten most frequent first moves when I am playing white and when I am playing black. You can see that `d4 d5` doesn't appear on the top ten at all when playing white. The only times I face the `d4 d5` opening (which might lead to Queen's Gambit) is when I play black.\n\n```{r}\n#| label: frequent-openings\n#| echo: !expr F\n#most frequent openings\ndata_for_freq_op <-\nmy_games %>% \n  mutate(playing = ifelse(White==\"matiasandina\",\n                          \"Playing White\", \"Playing Black\"), \n          playing = fct_rev(factor(playing)),\n         first = paste(W1, B1) ) %>%\n  count(playing, first) %>%\n  group_by(playing) %>%\n  slice_max(n=10, order_by = n) %>%\n  mutate(first = fct_reorder(first, n)\n    #first = tidytext::reorder_within(first, by=n, within = playing)\n    )\n\ndata_for_freq_op %>% \n  ggplot(aes(first, n)) + \n  geom_col()+ \n  geom_col(data = filter(data_for_freq_op, first == \"d4 d5\"),\n           aes(first, n), fill=\"darkred\") +\n  coord_flip()+\n  #tidytext::scale_x_reordered()+\n  facet_wrap(~playing)+\n  ggthemes::theme_fivethirtyeight()+\n  labs(title = \"Queen's gambit is played on me\",\n       subtitle = \"Tally of the top 10 first moves when I'm playing white or black\",\n       caption = general_caption)\n```\n\n### How often do I play against the gambit?\n\nThe amount I play has not been even over the years, but the frequency of games where I play the gambit seems somewhat marginal and independent of the how much I play.\n\n```{r}\n#| label: all-games-by-year\n#| echo: false\n# my_games %>% group_by(year) %>% ggplot(aes(year)) + geom_bar()\nmy_games %>% \n  mutate(open = paste(W1, B1, W2),\n         queen_gambit = ifelse(\n           open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\",\n           \"Queen's Gambit\", \n           \"other\")) %>% \n  group_by(year) %>% \n  count(queen_gambit) %>% \n  mutate(prop = n/sum(n)) -> gambit_prop_my_games\n\ngambit_prop_my_games %>% \n  ggplot(aes(year, n)) + \n  geom_col(aes(fill=fct_relevel(queen_gambit, c(\"Queen's Gambit\", \"other\"))))+\n  scale_fill_brewer(palette=\"Set1\")+\n  ggthemes::theme_fivethirtyeight()+\n  labs(title=\"All my games by year\", \n       fill=\"\",\n       caption=general_caption)\n```\n\nMarginal proportions are hard to see on a frequency graph, so maybe this graph is a bit more evident. I have played the Queen's Gambit in roughly `r gambit_prop_my_games %>% filter(queen_gambit==\"Queen's Gambit\") %>% pull(prop) %>% mean() %>% round(digits=2) %>% scales::percent(accuracy=0.1)` of the games. The game sample from 2021 might not be big enough to be representative (only January is present).\n\n```{r}\n#| label: prop-games-by-year\n#| echo: false\ngambit_prop_my_games %>% \n  ggplot(aes(year, prop)) +\n  geom_col(aes(fill=fct_relevel(queen_gambit, c(\"Queen's Gambit\", \"other\"))))+\n    scale_fill_brewer(palette=\"Set1\")+\n  ggthemes::theme_fivethirtyeight()+\n  scale_y_continuous(labels = scales::label_percent())+\n  scale_x_continuous(breaks=2012:2021)+\n  geom_label(\n    data = filter(gambit_prop_my_games, queen_gambit==\"Queen's Gambit\"),\n    mapping = aes(x = year, y = 1.05, label=scales::percent(prop, accuracy = 0.1))) + \n  labs(title=\"All my games by year\",\n       subtitle=\"Label shows percentage of Queen's Gambit Games\",\n       fill=\"\",\n       caption=general_caption)\n```\n\nThe small increases in late years are not big enough for me to notice, especially when spread evenly across the year. But what happens if we only look at 2020? The TV series started in October. In November, we see a big jump in the Queen's Gambit's frequency!\n\n```{r}\n#| label: gambit-pop\n#| echo: false\nmy_games %>% \n  filter(year >= 2020) %>% \n  mutate(open = paste(W1, B1, W2), \n         queen_gambit = case_when(open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\" ~ \"Queen's Gambit\",\n                                  paste(W1, B1) == \"e4 d5\" ~ \"Scandinavian Defense\", \n                                  TRUE ~ \"other\"), \n         month = lubridate::as_date(cut(Date, \"1 month\"))) %>% \n  group_by(month) %>% \n  count(queen_gambit) %>% \n  mutate(prop = n/sum(n)) %>% \n  filter(queen_gambit==\"Queen's Gambit\") %>% \n  ggplot(aes(month, prop)) + \n  geom_col() + \n  scale_x_date(breaks = \"1 month\", date_labels = \"%b\\n%Y\")+\n  scale_y_continuous(label=scales::label_percent())+\n  ggthemes::theme_fivethirtyeight() +\n  labs(title=\"Proportion of Queen's Gambit Games\",\n       caption=general_caption,\n       x=\"\")\n```\n\n\nThis is increase is not big. In fact, during November I also played the Scandinavian Defense[^another] more often. But even so, the **Queen's Gambit** got a ~3X jump on November, something that is way more noticeable when going from ~2.5% to ~ 7.5% than a 5-10% increase in an opening that I already play pretty often.\n\n[^another]: Scandinavian Defense is a position characterized by `1.e4 d5`, it's by far my prefered opening when playing black.\n\n```{r}\n#| label: gambit-pop2\n#| echo: false\nmy_games %>% \n  filter(year >= 2020) %>% \n  mutate(open = paste(W1, B1, W2), \n         queen_gambit = case_when(open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\" ~ \"Queen's Gambit\", \n                                  paste(W1, B1) == \"e4 d5\" ~ \"Scandinavian Defense\",\n                                  TRUE ~ \"other\"), \n         month = lubridate::as_date(cut(Date, \"1 month\"))) %>%\n  group_by(month) %>%\n  count(queen_gambit) %>%\n  mutate(prop = n/sum(n)) %>%\n  filter(queen_gambit %in% c(\"Scandinavian Defense\", \"Queen's Gambit\")) %>% \n  ggplot(aes(month, prop, fill=queen_gambit)) + \n  geom_col(position=\"dodge\") +\n  scale_y_continuous(label=scales::label_percent())+\n  scale_x_date(breaks = \"1 month\", date_labels = \"%b\\n%Y\")+\n  ggthemes::theme_fivethirtyeight()+\n  scale_fill_brewer(palette=\"Set1\")+\n  labs(\n    title = \"Proportion of games by opening\",\n    fill = \"\",\n    caption=general_caption\n    )\n\n\n```\n\n## Wrap\n\nThis project started with just an intuition and went down the rabbit hole of exploration. It took quite a long time to write (and re-write), but I was a lot of fun to mess around with. I hope you have enjoyed it if you made it this far!\n\n## More readings\n\nIf you want to read a nice, data rich, post about the \"Chess Boom\" that\nthe series brought about, check\n<https://www.bloomberg.com/graphics/2020-chess-boom/>.\n\nEven if you ask, Chess.com does not give you all the games in your\ndatabase nicely (probably trying to limit the bandwidth). So I slightly\nadapted the following script\n<https://github.com/arnsholt/chesscom-games> for the purpose of \"Gimme\nall my games with almost no clicks involved!\". It uses the API, so I\nthink it's all cool :).\n\nI should have probably searched for somebody's package. Here are some references that might be useful:\n\n* [https://github.com/JaseZiv/chessR](https://github.com/JaseZiv/chessR)\n* [https://github.com/curso-r/chess](https://github.com/curso-r/chess)\n","srcMarkdownNoYaml":"\n\nI love games. I enjoy the fun in many formats: cards, boards, consoles.\nYet, over the years, chess has consolidated as the game I play most often, and it is likely the only game I both **really** like and can limit the amount I play[^1].\n\n[^1]: However, after reading this post you might believe I'm a bit of a\n    chess junkie üòù\n\nIt's been a couple of months since I noticed something weird going on in my games, a sort of disturbance in the force. I felt I was playing a type of position called **Queen's Gambit** way more often than normal. \n\nBecause there's currently a sort of chess mania fueled by the very successful new series that gets the name from the gambit[^2], I thought it would be pretty easy to find out whether the data reflected my gut feeling.\n\n[^2]: But mostly because the star is a kick-ass woman.\n\n## Too Long ‚Äî Didn't Read\n\nI apologize for writing long posts. Be my guest and jump directly to the popularity of the Queen's Gambit across time by clicking [here](#popularity)\n\n## The data\n\nTo do any sort of analysis, I needed data. Although there are probably many places where I could have found it, `www.chess.com` has a large dataset and it is somewhat accessible (if you can parse websites, see [how](#more-readings)). It is also the place where I play, so the dataset of *my* games comes from there. \n\nThroughout this post, I will be using two datasets:\n\n1) Master Games: games played by Chess Masters where Queen's Gambit is played.\n2) My games: All my games at chess.com, spanning from 2012 to January 2021.\n\nLet's minimally explore the dataset of Master Games for the sake of DataViz üìà.\n\n```{r}\n#| label: setup\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(tidyverse, warn.conflicts = F)\n# read previous datasets\ndf <- read_csv(\"./queens_gambit/queen_gambit.csv\")\nmy_games <- read_csv(\"./queens_gambit/chess_games/my_games_UNPUBLISHED.csv\")\n\n# add text result to the data\ndf <- \ndf %>% \n  mutate(text_result = case_when(Result == \"1-0\" ~ \"white wins\",\n                                 Result == \"0-1\" ~ \"black wins\",\n                                 TRUE ~ \"draw\"),\n         text_result = factor(text_result, \n                              levels = c(\"white wins\", \"draw\", \"black wins\"))) \n\ngeneral_caption <- \"Source: chess.com\\nViz: @NeuroMLA\"\n\n```\n\nI first started looking at a dataset with `r nrow(df)` entries, from games played between chess Masters (aka Master Games) that open with Queen's Gambit. Games were played between `r min(df$Year)` and `r max(df$Year)`. After a bit of data cleaning, there were a few quick things I wanted to look at.\n\nBelow, you can find a violin plot of the number of moves a chess match between masters normally has.\n\n```{r}\n#| echo: false\n \ndf %>% \n  ggplot(aes(text_result, Moves, fill=text_result)) +\n  geom_violin()+\n  stat_summary(fun.data = mean_se,\n               show.legend = F,\n               color=\"#bbb4a9ff\")+\n  scale_y_continuous(breaks=seq(0,200,40))+\n  ggthemes::theme_fivethirtyeight() +\n  theme(plot.title = element_text(hjust = 0.5)) +\n  scale_fill_manual(values = c(\"white\", \"#777574ff\", \"black\"))+\n  labs(fill = \"\",\n       title = \"Chess Master Games last around 40 moves\",\n       caption = general_caption)\n \n```\n\nIf you are curious, here's a table with summary statistics for the number of moves in the games by result.\n\n```{r}\n#| label: table-results\n#| warning: !expr F\n#| message: !expr F\n#| echo: !expr F\ntibble_summary <- function(x){\n  summary(x) %>% \n    as.matrix() %>% \n    t() %>% \n    as_tibble() %>% \n    janitor::clean_names() %>% \n    rename(q25 = x1st_qu,\n           q75 = x3rd_qu)\n}\n  \ndt <-   \ndf %>% \n  group_by(text_result) %>% \n  summarise(y=list(tibble_summary(Moves))) %>% \n  unnest(y) %>% \n  rename(Result = text_result) %>%\n  mutate_if(is.numeric, ~round(., digits=2)) \n\ndt %>% \n  gt::gt()\n\n# data table not rendering right now\n#dt %>% \n#  DT::datatable(options = list(dom = 't'))\n```\n\n\n```{r}\n#| label: data-clean\n#| echo: !expr F\n#| warning: !expr F\n#| message: !expr F\nclean_df <- \ndf %>%\n  mutate(Players=str_squish(Players)) %>% \n  separate(Players, into=c(\"Players\", \"moves\"), sep=\" 1. \") %>%\n  separate(moves, into=c(\"moves\", \"accepted\"), sep = \" Queen's Gambit\") %>%\n  separate(accepted, into=c(\"accepted\", \"variation\"), sep=\": \") %>% \n  separate(moves, into = c(\"first\", \"second\", \"third\"), sep=\" [2-3]\\\\. \")\n\n# a few ones need further cleaning\nclean_df <- \n  clean_df %>% \n  filter(accepted != \"\") %>% \n  filter(!str_detect(string = accepted, pattern = \" Declined with.\")) %>% \n  mutate(Result = factor(Result, levels = c(\"1-0\", \"¬Ω-¬Ω\", \"0-1\")))\n\n```\n\n## What is this \"Queen's Gambit\", anyway?\n\nGenerally speaking, a gambit is a position where both players stand to exchange pieces. In the particular case of the **Queen's Gambit**, we are most often referring to this position (although see further below).\n\n```{r}\n#| out.width: 50%\n#| out.height: 50%\n#| echo: !expr F\n#| fig.align: center\nknitr::include_graphics(\"./queens_gambit/boards/board01.png\")\n```\n\n## When does it happen?\n\nQueen's gambit is an opening, this means it occurs early in the game. In this case, the gambit is overwhelmingly proposed on the second move and just a few games develop into a position that is equivalent to the Queen's gambit later in the game.\n\n```{r}\n#| echo: !expr F\nclean_df %>% \n  count(second = str_detect(second, \"^c4\"),\n        third = str_detect(third, \"^c4\")) %>%\n  mutate(proposal = factor(c(\"later\", \"third move\", \"second move\"),\n                           levels = c(\"second move\", \"third move\", \"later\"))) %>%\n  ggplot() +\n  geom_col(aes(proposal, n)) +\n  geom_text(aes(proposal, n - n/10, label=n), vjust = -0.5) +\n  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale()))+\n  ggthemes::theme_fivethirtyeight() +\n  labs(title=\"Games with Queen's Gambit proposal\",\n       subtitle = \"Counting games with proposal on 2nd move, 3rd move, or afterwards\",\n       caption = general_caption)\n\n```\n\n## Who benefits?\n\nIn chess, whoever starts (aka plays white) has advantage. However, Chess Masters are heavily trained in defense, so it's not a walk in the part for white. It always depends heavily on the initial positions (openings), gambit proposals, and responses (accepted or declined with many variations). In the case of the Queen's Gambit, the machines predict white is favorite to win, while accepting the gambit increases the likelihood of draws. Interestingly, if we calculate the expected value for black from the observed frequencies, it might be slightly better for black to accept the gambit[^3].\n\n[^3]: I'm using the observed frequencies and calculating one point per     win and 0.5 points per draw. This gives the expected values for each     player.\n\n```{r}\n#| label: barplots-patch\n#| message: !expr F\n#| echo: !expr F\nprop_df <- \nclean_df %>% \n  count(accepted, text_result) %>% \n  group_by(accepted) %>% \n  mutate(total = sum(n),\n         prop = n/total,\n         pos = 1 - cumsum(prop) + prop/2)\n# barplot\nprop_plot <-\nprop_df %>% \n  ggplot()+ \n  geom_col(aes(accepted, prop, fill = text_result), color=\"black\") +\n  geom_text(aes(accepted, pos, label = scales::percent(prop, accuracy = 1L)),\n            color=\"#bbb4a9ff\", size=12) +\n  scale_fill_manual(values = c(\"white\", \"#777574ff\", \"black\"))+\n  ggthemes::theme_fivethirtyeight(base_size = 16) +\n  labs(fill= \"\",\n       title=\"Accepting Queen's Gambit: better for black?\",\n       subtitle=\"Proportion of Master Games\") +\n  coord_flip()\n\n# expected_win\nexpected_game_value <-\nprop_df %>% \n  group_by(accepted) %>% \n  summarise(expected_white = \n              0.5 * prop[text_result==\"draw\"] + \n              1 * prop[text_result==\"white wins\"],\n            expected_black = \n              0.5 * prop[text_result==\"draw\"] + \n              1 * prop[text_result==\"black wins\"]\n              ) %>% \n  pivot_longer(-accepted) %>%\n  mutate(name = str_remove(name, \"expected_\")) %>% \n  group_by(accepted) %>% \n  mutate(pos = ifelse(name==\"black\",\n                      1 - value/2,\n                      value - value/2)) %>% \n  ggplot(aes(accepted, value, fill=name))+\n  geom_col(color=\"black\") +\n  geom_text(aes(accepted, pos,\n                label= round(value, 2)),\n            hjust = 0.5, \n            color=\"#bbb4a9ff\", size=12)+\n  coord_flip()+\n  scale_fill_manual(values=c(\"black\", \"white\"))+\n  ggthemes::theme_fivethirtyeight(base_size = 16)+\n  labs(subtitle=\"Expected Game Value (based on observed proportions)\",\n       fill=\"\",\n       caption = general_caption) \n\nlibrary(patchwork)\nbars_together <- \nprop_plot / expected_game_value +\n  plot_layout(nrow=2, widths = c(1.5,1)) #+\n  #plot_annotation()\n\n# I cannot figure out how to do the proper ggsave here. doing it manually\n# ggsave(plot = bars_together, filename = \"./queens_gambit/bars_together.png\", width=8, height=4)\n\n```\n\n\n```{r}\n#| label: bars-together-plot\n#| echo: false\n#| out.width: 80%\n#| out.height: 80%\nknitr::include_graphics(\"./queens_gambit/bars_together.png\")\n\n```\n\n\nI wouldn't treat this tiny increment as something real. It is likely just noise. In reality, Chess Masters decline the Queen's gambit way more often than they accept it (about\n`r clean_df %>% count(accepted) %>% summarise(prop=round(last(n)/first(n), 2)) %>% pull(prop)` times more often!). \n\nIn fact, if we check with the chess engines, they seldom accept the Queen's Gambit either. On a personal, totally amateur note, I don't feel like accepting the Queen's Gambit, it just doesn't feel right.\n\n## Where do they go?\n\nAfter the opening, chess games branch into a myriad possible positions. I believe a cool way to see this is to use alluvial plots to visualize how the games evolve in time. It would really be a mess to visualize all moves, so I just focused on certain games and kept it short around proposal/response in regards to Queen's Gambit. I added the result of the game, just out of curiosity.\n\n```{r}\n#| label: alluvial\n#| message: !expr F\n#| warning: !expr F\n#| echo: !expr F\nlibrary(ggalluvial)\nclean_df %>% \n  mutate(first = paste(\"1.\", first, \"\\n2. c4\"),\n         second = str_remove(second, \"c4 \")) %>% \n  # remove \"Nf3 Nf6\" so we only focus on the gambit on the first two moves\n  filter(second != \"Nf3 Nf6\") %>% \n  # lump the moves \n  mutate(first = fct_lump_min(factor(first), min = 1500),\n         second = fct_lump_min(factor(second), min = 1000),\n         third = fct_lump_min(factor(third), min = 1000)) %>%\n  # remove first == \"other\"\n  filter(first != \"Other\") %>% \n  group_by(accepted) %>%  \n  count(first, second, third, text_result) %>% \nggplot(aes(axis1 = first, axis2 = second, axis3 = third, axis4=text_result,\n           y = n)) +\n  scale_x_discrete(limits = c(\"White moves c4\", \"Black's\\nResponse\", \"Third\\nMove\", \"Result\"),\n                   expand = c(0.1, 0.1)) +\n  geom_alluvium(aes(fill=accepted), width = 0.5) +\n  geom_stratum(width=0.5, alpha=0) +\n  geom_text(stat = \"stratum\", \n            aes(label = after_stat(stratum)), fontface = \"bold\")+\n  ggthemes::theme_fivethirtyeight() +\n  theme(legend.position = \"bottom\",\n        axis.text.y = element_blank(),\n        panel.grid.major = element_blank(),\n        plot.title = element_text(hjust=0.5)) +\n  scale_fill_brewer(palette = \"Set1\") +\n  labs(title=\"Flow of Master Chess Games After Queen's Gambit\",\n       fill=\"Queen's Gambit\",\n       caption= general_caption)\n\n\n```\n\nAs you can see, I focused on the two cases where white moves their pawn\nto c4 (`c4`) to actually \"propose\" the gambit. This is how both\nsituations look on the board.\n\n|           1\\. d4 d5 2. c4                                             |                1\\. d4 Nf3 2. c4                                            |\n|:-------------------------------------------------------------:|:-------------------------------------------------------------:|\n| <img src=\"./queens_gambit/boards/board01.png\" width=\"180\"/> | <img src=\"./queens_gambit/boards/board02.png\" width=\"180\"/> |\n\n\"Accepting\" the gambit means taking the pawn at c4 (`dxc4`). As we said before, this is the least frequent case, and it is interesting to see that almost none of the `Nf6` games go to accept the gambit. It's also quite telling that the vast majority of Masters respond to Queen's Gambit with `e6`. This is how it looks in the board.\n\n\n|                      1\\. d4 d5 2. c4 e6                      |                         1. d4 Nf6 2. c4 e6                       |\n|:------------------------------------------------------------:|:----------------------------------------------------------------:|\n| <img src=\"./queens_gambit/boards/board_e6.png\" width=\"180\"/> | <img src=\"./queens_gambit/boards/board_Nf6_e6.png\" width=\"180\"/> |\n\n### Special case\n\nThere's a special case where games take a bit longer to reach the gambit.  These are the games where the second move is `Nf3 Nf6`. I made the same alluvial plot for these games. For some reason, this position prompts the majority of Chess Masters to accept the gambit.\n\nThus, if you like to play the gambit as white, and you like the other side to accept it, you should delay your `c4` advance just one move.\n\n```{r}\n#| message: !expr F\n#| warning: !expr F\n#| echo: !expr F\nclean_df %>% \n  # get \"Nf3 Nf6\" \n  filter(second == \"Nf3 Nf6\") %>% \n  mutate(first = fct_lump_min(factor(first), min = 200),\n         second = fct_lump_min(factor(second), min = 1000),\n         third = fct_lump_min(factor(third), min = 200)) %>%\n  # remove first == \"other\"\n  #filter(first != \"Other\") %>% \n  group_by(accepted) %>%  \n  count(first, second, third, text_result) %>% \n  ggplot(aes(axis1 = first, axis2 = second, axis3 = third, axis4=text_result,\n             y = n)) +\n  scale_x_discrete(limits = c(\"First\\nMove\", \"Second\\nMove\", \"Third\\nMove\", \"Result\"),\n                   expand = c(0.1, 0.1)) +\n  geom_alluvium(aes(fill=accepted), width = 0.5) +\n  geom_stratum(width=0.5, alpha=0) +\n  geom_text(stat = \"stratum\", \n            aes(label = after_stat(stratum)), fontface = \"bold\")+\n  ggthemes::theme_fivethirtyeight() +\n  scale_fill_brewer(palette = \"Set1\") +\n  labs(title=\"Flow of Master Chess Games After Queen's Gambit\",\n       subtitle=\"Only showing games where `2. Nf3 Nf6` was second move\",\n       fill=\"Queen's Gambit\",\n       caption=\"Source: chess.com | Viz: @NeuroMLA\")+\n  theme(legend.position = \"bottom\",\n        axis.text.y = element_blank(),\n        panel.grid.major = element_blank(),\n        plot.title = element_text(hjust=0.5),\n        plot.subtitle = element_text(hjust=0.5)) \n\n```\n\nThis is how your board should look like if you want black to accept the gambit.\n\n\n```{r}\n#| out.width: 50%\n#| out.height: 50%\n#| echo: !expr F\n#| fig.align: center\nknitr::include_graphics(\"./queens_gambit/boards/board_second_move_accept.png\")\n```\n\n\n## Popularity\n\nEnough with the chess lingo, show me what I came here for! Alright, alright, don't bark. Here's the popularity plot on the Masters Games.\n\n```{r}\n#| label: pop-plot-masters\n#| echo: !expr F\nclean_df %>% \n  count(Year) %>% ggplot(aes(Year, n))+ \n  ggthemes::theme_fivethirtyeight()+\n  geom_line(lwd=1) +\n  geom_point(size=3) +\n  labs(title = \"Frequency of Queen's Gambit Games\",\n       subtitle=\"Data from Chess Masters\",\n        caption = general_caption)\n\n\n```\n\nThis plot shows that the popularity of the gambit increased dramatically. But my prediction was *wrong*, the gambit was super popular a few years ago and I didn't notice anything.\n\nWhat happened between 2017 and 2019? I don't really know if the total amount of games just skyrocketed, but it's possible. Maybe the 2018 world championship had something to do with it. I didn't parse the full database, so I can't tell you about the frequency of all games. \n\nWhat happened in 2020? If you are from the future, I would like to remind you that there was a Global Pandemic on 2020, stay safe whenever you are.\n\nThe popularity graph didn't show what I was expecting to see, but I still trust my gut feeling. It all started just a few months ago, I'm pretty sure that there is something in the data that needs to be unmasked. \n\nData from 2020 will not reflect my gut feeling easily. First, the pandemic messed up with the tournament schedule. Second, the TV series might be super popular with normal people, but we shouldn't expect Chess Masters to change the way they open games because of it. \n\nSo...what about simple mortals like you and me? Well, my friend, if you made it this far, I trust you to go on with my game database.\n\n## My games\n\nFirst, you should know that I *mostly* play blitz games (either 3 minutes in the clock at start or 3 minutes with 2 seconds added per move). Nonetheless, it looks like the move distribution of games is quite similar to what we see in Masters games.\n\n```{r}\n#| label: density_plot\n#| echo: !expr F\ndensity_plot_for_arrows <-\nggplot() +\n  geom_density(data = my_games,\n               aes(NMoves, fill = \"My Games\"), alpha=0.8)+\n  geom_density(data=df,\n               aes(Moves, fill = \"Master Games\"), alpha=0.8)+\n    see::scale_fill_material()+\n    ggthemes::theme_fivethirtyeight()+\n    theme(#axis.text.y = element_blank(),\n          axis.title = element_text())+\n    labs(fill=\"\", \n         y=\"Game Frequency\", \n         x = \"Moves per game\",\n         title = \"\",\n         caption = general_caption)\n\ndensity_plot_for_arrows\n```\n\nThere are two places where I see differences. First, Master Games show a bump quite early, even below 20 moves. This is unusual because it takes more moves to break a good defense. We will come back later to this.\n\n```{r}\n#| label: first-arrow\n#| echo: !expr F\ndensity_plot_for_arrows +\n  annotate(\n    geom = \"curve\", x = -0.1, y = 0.02, xend = 5, yend = 0.01, \n    curvature = .05, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"label\", x = 2, y = 0.022,\n           label = \"1\")\n```\n\nSecond, there is another bump on longer games. I attribute this to the nature of my skill level. I can't play much more than an opening and a few attempts on the \"middle game\". Most of my games will evolve pretty quickly (either because the clock forces you to be aggressive or because our chess level is not good). It's often the case that one player makes a crucial mistake and the game evolves fast after that.\n\n```{r}\n#| label: second-arrow\n#| echo: false\ndensity_plot_for_arrows +\n  annotate(\n    geom = \"curve\", x = 100, y = 0.01, xend = 80, yend = 0.005, \n    curvature = .1, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"label\", x = 105, y = 0.01,\n           label = \"2\")\n\n```\n\nThere's another explanation for these differences. If we separate games according to result. We see that Masters games have almost the same shape as mine but, when they get to a draw, they get to it really fast. For us novices, getting a draw is often an accident. Masters deliberately draw, and they do it early.\n\n```{r}\n#| label: facet-result\n#| echo: !expr F\n# add results\nmy_games <- my_games %>% \n  mutate(text_result = case_when(Result == \"1-0\" ~ \"white wins\",\n                                 Result == \"0-1\" ~ \"black wins\", TRUE ~ \"draw\"),\n         text_result = factor(text_result, levels = c(\"white wins\", \"draw\", \"black wins\")))\n\n# add years\nmy_games <- my_games %>%\n  mutate(Date = lubridate::as_date(Date),\n         year = lubridate::year(Date))\n\n# most typical variations\n#clean_df %>% count(variation, sort = T)\n\nbind_rows(select(clean_df, Moves, text_result) %>%\n            mutate(source = \"Masters Games\"),\n          select(my_games, Moves = NMoves, text_result) %>%\n            mutate(source = \"My Games\")) %>% \n  ggplot()+\n  geom_density(aes(Moves, fill=source), alpha=0.8)+\n  facet_wrap(~text_result)+ \n  see::scale_fill_material()+ \n  ggthemes::theme_fivethirtyeight()+ \n  theme(axis.text.y = element_blank(), axis.title = element_text())+ \n  labs(fill=\"\", y=\"Game Frequency\", \n       x = \"Moves per game\", \n       title = \"Master Games get into draws much faster\", \n       caption = general_caption)\n\n\n\n```\n\n### Drawing is a signal of quality\n\nAt my level, drawing a game is not common. For pros, it's quite the opposite. Something else that draws my attention is that black is really unlikely to win a game. This is similar to other games, like tennis, where the player that serves (aka, starts the game) has a huge advantage.\n\n```{r}\n#| label: result-prop\n#| echo: false\n# Result proportions\n\nbind_rows( clean_df %>% count(text_result) %>% \n             mutate(prop = n/sum(n), source = \"Master Games\"), \n           my_games %>% count(text_result) %>% \n             mutate(prop = n/sum(n), source = \"My Games\") ) %>% \n  ggplot(aes(text_result, prop, fill=source))+ \n  geom_col(position=\"dodge\", alpha=0.8)+ \n  scale_y_continuous(labels=scales::label_percent())+ \n  scale_fill_brewer(palette = \"Set1\", direction = -1)+ \n  ggthemes::theme_fivethirtyeight()+ \n  theme(axis.title = element_text())+ \n  labs(fill=\"\", y=\"Game Frequency\", \n       x=\"\",\n       title = \"Master Games get into draws more often\", \n       caption = general_caption)\n\n```\n\n### My openings\n\nIn my database, I have all the games I played. Up to February 2021, it was a total of `r nrow(my_games)`. Yes, I know, a lot, roughly `r round(nrow(my_games)/(max(my_games$year) - min(my_games$year)) / 365, 2)` per day since `r min(my_games$year)`. Anyway, I can get all the openings from my games.\n\nI selected the ten most frequent first moves when I am playing white and when I am playing black. You can see that `d4 d5` doesn't appear on the top ten at all when playing white. The only times I face the `d4 d5` opening (which might lead to Queen's Gambit) is when I play black.\n\n```{r}\n#| label: frequent-openings\n#| echo: !expr F\n#most frequent openings\ndata_for_freq_op <-\nmy_games %>% \n  mutate(playing = ifelse(White==\"matiasandina\",\n                          \"Playing White\", \"Playing Black\"), \n          playing = fct_rev(factor(playing)),\n         first = paste(W1, B1) ) %>%\n  count(playing, first) %>%\n  group_by(playing) %>%\n  slice_max(n=10, order_by = n) %>%\n  mutate(first = fct_reorder(first, n)\n    #first = tidytext::reorder_within(first, by=n, within = playing)\n    )\n\ndata_for_freq_op %>% \n  ggplot(aes(first, n)) + \n  geom_col()+ \n  geom_col(data = filter(data_for_freq_op, first == \"d4 d5\"),\n           aes(first, n), fill=\"darkred\") +\n  coord_flip()+\n  #tidytext::scale_x_reordered()+\n  facet_wrap(~playing)+\n  ggthemes::theme_fivethirtyeight()+\n  labs(title = \"Queen's gambit is played on me\",\n       subtitle = \"Tally of the top 10 first moves when I'm playing white or black\",\n       caption = general_caption)\n```\n\n### How often do I play against the gambit?\n\nThe amount I play has not been even over the years, but the frequency of games where I play the gambit seems somewhat marginal and independent of the how much I play.\n\n```{r}\n#| label: all-games-by-year\n#| echo: false\n# my_games %>% group_by(year) %>% ggplot(aes(year)) + geom_bar()\nmy_games %>% \n  mutate(open = paste(W1, B1, W2),\n         queen_gambit = ifelse(\n           open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\",\n           \"Queen's Gambit\", \n           \"other\")) %>% \n  group_by(year) %>% \n  count(queen_gambit) %>% \n  mutate(prop = n/sum(n)) -> gambit_prop_my_games\n\ngambit_prop_my_games %>% \n  ggplot(aes(year, n)) + \n  geom_col(aes(fill=fct_relevel(queen_gambit, c(\"Queen's Gambit\", \"other\"))))+\n  scale_fill_brewer(palette=\"Set1\")+\n  ggthemes::theme_fivethirtyeight()+\n  labs(title=\"All my games by year\", \n       fill=\"\",\n       caption=general_caption)\n```\n\nMarginal proportions are hard to see on a frequency graph, so maybe this graph is a bit more evident. I have played the Queen's Gambit in roughly `r gambit_prop_my_games %>% filter(queen_gambit==\"Queen's Gambit\") %>% pull(prop) %>% mean() %>% round(digits=2) %>% scales::percent(accuracy=0.1)` of the games. The game sample from 2021 might not be big enough to be representative (only January is present).\n\n```{r}\n#| label: prop-games-by-year\n#| echo: false\ngambit_prop_my_games %>% \n  ggplot(aes(year, prop)) +\n  geom_col(aes(fill=fct_relevel(queen_gambit, c(\"Queen's Gambit\", \"other\"))))+\n    scale_fill_brewer(palette=\"Set1\")+\n  ggthemes::theme_fivethirtyeight()+\n  scale_y_continuous(labels = scales::label_percent())+\n  scale_x_continuous(breaks=2012:2021)+\n  geom_label(\n    data = filter(gambit_prop_my_games, queen_gambit==\"Queen's Gambit\"),\n    mapping = aes(x = year, y = 1.05, label=scales::percent(prop, accuracy = 0.1))) + \n  labs(title=\"All my games by year\",\n       subtitle=\"Label shows percentage of Queen's Gambit Games\",\n       fill=\"\",\n       caption=general_caption)\n```\n\nThe small increases in late years are not big enough for me to notice, especially when spread evenly across the year. But what happens if we only look at 2020? The TV series started in October. In November, we see a big jump in the Queen's Gambit's frequency!\n\n```{r}\n#| label: gambit-pop\n#| echo: false\nmy_games %>% \n  filter(year >= 2020) %>% \n  mutate(open = paste(W1, B1, W2), \n         queen_gambit = case_when(open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\" ~ \"Queen's Gambit\",\n                                  paste(W1, B1) == \"e4 d5\" ~ \"Scandinavian Defense\", \n                                  TRUE ~ \"other\"), \n         month = lubridate::as_date(cut(Date, \"1 month\"))) %>% \n  group_by(month) %>% \n  count(queen_gambit) %>% \n  mutate(prop = n/sum(n)) %>% \n  filter(queen_gambit==\"Queen's Gambit\") %>% \n  ggplot(aes(month, prop)) + \n  geom_col() + \n  scale_x_date(breaks = \"1 month\", date_labels = \"%b\\n%Y\")+\n  scale_y_continuous(label=scales::label_percent())+\n  ggthemes::theme_fivethirtyeight() +\n  labs(title=\"Proportion of Queen's Gambit Games\",\n       caption=general_caption,\n       x=\"\")\n```\n\n\nThis is increase is not big. In fact, during November I also played the Scandinavian Defense[^another] more often. But even so, the **Queen's Gambit** got a ~3X jump on November, something that is way more noticeable when going from ~2.5% to ~ 7.5% than a 5-10% increase in an opening that I already play pretty often.\n\n[^another]: Scandinavian Defense is a position characterized by `1.e4 d5`, it's by far my prefered opening when playing black.\n\n```{r}\n#| label: gambit-pop2\n#| echo: false\nmy_games %>% \n  filter(year >= 2020) %>% \n  mutate(open = paste(W1, B1, W2), \n         queen_gambit = case_when(open == \"d4 d5 c4\" | open == \"d4 Nf6 c4\" ~ \"Queen's Gambit\", \n                                  paste(W1, B1) == \"e4 d5\" ~ \"Scandinavian Defense\",\n                                  TRUE ~ \"other\"), \n         month = lubridate::as_date(cut(Date, \"1 month\"))) %>%\n  group_by(month) %>%\n  count(queen_gambit) %>%\n  mutate(prop = n/sum(n)) %>%\n  filter(queen_gambit %in% c(\"Scandinavian Defense\", \"Queen's Gambit\")) %>% \n  ggplot(aes(month, prop, fill=queen_gambit)) + \n  geom_col(position=\"dodge\") +\n  scale_y_continuous(label=scales::label_percent())+\n  scale_x_date(breaks = \"1 month\", date_labels = \"%b\\n%Y\")+\n  ggthemes::theme_fivethirtyeight()+\n  scale_fill_brewer(palette=\"Set1\")+\n  labs(\n    title = \"Proportion of games by opening\",\n    fill = \"\",\n    caption=general_caption\n    )\n\n\n```\n\n## Wrap\n\nThis project started with just an intuition and went down the rabbit hole of exploration. It took quite a long time to write (and re-write), but I was a lot of fun to mess around with. I hope you have enjoyed it if you made it this far!\n\n## More readings\n\nIf you want to read a nice, data rich, post about the \"Chess Boom\" that\nthe series brought about, check\n<https://www.bloomberg.com/graphics/2020-chess-boom/>.\n\nEven if you ask, Chess.com does not give you all the games in your\ndatabase nicely (probably trying to limit the bandwidth). So I slightly\nadapted the following script\n<https://github.com/arnsholt/chesscom-games> for the purpose of \"Gimme\nall my games with almost no clicks involved!\". It uses the API, so I\nthink it's all cool :).\n\nI should have probably searched for somebody's package. Here are some references that might be useful:\n\n* [https://github.com/JaseZiv/chessR](https://github.com/JaseZiv/chessR)\n* [https://github.com/curso-r/chess](https://github.com/curso-r/chess)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"filters":["social-embeds","social-share"],"include-after-body":["../../footer.html"],"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","editor":"visual","comments":{"utterances":{"repo":"matiasandina/Webpage","label":"Comment","theme":"github-dark"}},"theme":{"light":["flatly","../../theme.scss"],"dark":["darkly","../../dark.scss"]},"code-copy":true,"grid":{"body-width":"900px","margin-width":"300px","gutter-width":"1.5rem"},"title-block-banner":true,"license":"CC BY","toc-title":"Table of contents","toc-location":"right","author":[{"name":"Matias Andina","url":"https://matiasandina.netlify.app","affiliation":"Massachusetts Institute of Technology","orcid":"0000-0002-1996-2539"}],"citation":true,"share":{"permalink":"https://matiasandina.netlify.app/","description":"Matias Andina","twitter":true,"facebook":true,"reddit":true,"stumble":true,"tumblr":false,"linkedin":true,"email":true,"mastodon":true},"title":"Queen's Gambit","subtitle":"A trip down the chess rabbit hole","date":"2021-02-07","categories":["chess","fun","design"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}