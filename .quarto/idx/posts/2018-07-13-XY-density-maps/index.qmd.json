{"title":"XY-density-maps","markdown":{"yaml":{"title":"XY-density-maps","date":"2018-07-13","output":"html_document","categories":["R"],"execute":{"echo":true}},"headingText":"Packages","containsRefs":false,"markdown":"\n\nI have been playing around with tracking software and the ways to visualize the position of an animal in an arena over time. Even with normal cameras (30 Hz) and relatively small periods of time (~5 min) we get massive datasets and the only way to make sense of them is to aggregate data over time. I have been interested in neat visualizations (using R), thus here are some ways/comments. I will explore different packages and doing comparisons of the results.\n\n\n\n```{r}\n#| label: load\n#| warning: false\nsuppressPackageStartupMessages(library(RColorBrewer))\nsuppressPackageStartupMessages(library(KernSmooth))\nsuppressPackageStartupMessages(library(raster))\nsuppressPackageStartupMessages(library(ggplot2))\nsuppressPackageStartupMessages(library(dplyr))\n\n```\n\n\n## Data\n\nI have an example dataset with `XY` position of the animal. I also have other morphological data that is irrelevant for this case. See example below: \n\n```{r}\n#| label: dataset\n#| echo: false\n\n\nrat_pos <- read.csv('2018-03-20-XY-density-maps-files/rloess_smooth.csv')\n\nhead(rat_pos)\n\n```\n\n\nI will do some setup that is common for all the graphs (aka, color palette and the dimensions of the arena).\n\n```{r}\n#| label: setup-bins\n# Get color palette \n\nrefCol <- colorRampPalette(rev(brewer.pal(6,'Spectral')))\nmycol <- refCol(6)\n\n# define bin sizes\nbin_size <- 40\n\n# Camera resolution is 640x480. Hence...\nxbins <- 640/bin_size \nybins <- 480/bin_size\n```\n\n## ggplot2\n\nThe reason I always go to `ggplot2` first is because it's awesome, I buy into the grammar and find it intuitive to accumulate layers over layers. The underlying thought is that `ggplot2` handles all problems. In this case, the result has some pros (layers, layers and more layer), and some cons (basically, it doesn't look amazing). \n\n```{r}\n#| label: ggplot2-option-1\np <- ggplot(rat_pos, aes(X,Y)) + \n  stat_density2d(geom = 'tile', \n                 aes(fill = after_stat(density)), \n                 contour = FALSE,\n                 n = c(xbins, ybins)) +\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_gradientn(colors =  mycol) +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))\n\nprint(p)\n```\n\nThis is interesting because we can overlay things into the plot. For example the trace:\n\n```{r}\n#| label: ggplot2-option-1-trace\n\np + geom_path(alpha=0.1)\n\n```\n\n\nWe can further remove the axis (or any other modifications we feel like doing). \n\n```{r}\n#| label: ggplot2-option-1-noborder\n\np + geom_path(alpha=0.5) + theme_void()\n\n```\n\n### Helping ggplot from outside\n\nI found that, if we calculate the density externally, it looks smoother. This is a mixed, `bkde2D` mediated, `ggplot2` approach (aka the best of 2 worlds).\n\n```{r}\n#| label: ggplot2-option-2\nbins <- bkde2D(as.matrix(rat_pos[,1:2]), \n               bandwidth = c(xbins, ybins),\n               gridsize = c(640L, 480L))\n\n# reshape\nbins_to_plot <- tidyr::pivot_longer(\n  data.frame(bins$fhat) %>% tibble::rownames_to_column(), \n  cols = -rowname) %>% \n  # fix the name column\n  mutate(name = stringr::str_remove(name, \"X\")) %>% \n  # convert to numeric\n  mutate_all(as.numeric)\n\n\nggplot(bins_to_plot, aes(rowname, name, fill = value)) +\n  geom_raster()+\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_gradientn(colors =  mycol) +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n\n```\n\n### 2023 Update\n\nAs of 2023, ggplot is able to handle 2D density heatmaps much better. I haven't played too much with it, but here are some examples\n\n```{r}\nggplot(rat_pos, aes(X,Y)) + \n           stat_density_2d(geom = \"polygon\", \n                           contour = TRUE,\n                           aes(fill = after_stat(level)),\n                  bins = 8)+\n  coord_equal() +\n  scale_fill_gradientn(colors =  mycol) +\n  theme_minimal() +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n```\n\n```{r}\nggplot(rat_pos, aes(X,Y)) + \n  geom_density_2d_filled(bins = 8)+\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_brewer(palette = \"Spectral\", direction = -1)+\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n```\n\n\n## Using raster package\n\nThe `raster` package is maybe an older solution, which is surprisingly low demand. In 3 lines of code we get a perfectly functional plot. On the other hand, it's not the best looking graph and we get the caveats (yes, `base` graphics).   \n\n```{r}\n#| label: raster-package\nr <- raster(xmn=0, ymn=0, xmx=640, ymx=480, res=20)\nx <- rasterize(rat_pos[,1:2], r, fun='count')\nplot(x, xlim=c(0,640), ylim=c(0,480), xaxt='n', ann=FALSE, yaxt='n')\n```\n\n\n## Documentation \n\nI have found a good amount of advice and inspiration in the links below. \n\n* http://stat405.had.co.nz/ggmap.pdf\n* https://stackoverflow.com/questions/24078774/overlay-two-ggplot2-stat-density2d-plots-with-alpha-channels?lq=1\n* https://www.r-bloggers.com/5-ways-to-do-2d-histograms-in-r/\n* https://stackoverflow.com/questions/24845652/specifying-the-scale-for-the-density-in-ggplot2s-stat-density2d\n","srcMarkdownNoYaml":"\n\nI have been playing around with tracking software and the ways to visualize the position of an animal in an arena over time. Even with normal cameras (30 Hz) and relatively small periods of time (~5 min) we get massive datasets and the only way to make sense of them is to aggregate data over time. I have been interested in neat visualizations (using R), thus here are some ways/comments. I will explore different packages and doing comparisons of the results.\n\n\n## Packages\n\n```{r}\n#| label: load\n#| warning: false\nsuppressPackageStartupMessages(library(RColorBrewer))\nsuppressPackageStartupMessages(library(KernSmooth))\nsuppressPackageStartupMessages(library(raster))\nsuppressPackageStartupMessages(library(ggplot2))\nsuppressPackageStartupMessages(library(dplyr))\n\n```\n\n\n## Data\n\nI have an example dataset with `XY` position of the animal. I also have other morphological data that is irrelevant for this case. See example below: \n\n```{r}\n#| label: dataset\n#| echo: false\n\n\nrat_pos <- read.csv('2018-03-20-XY-density-maps-files/rloess_smooth.csv')\n\nhead(rat_pos)\n\n```\n\n\nI will do some setup that is common for all the graphs (aka, color palette and the dimensions of the arena).\n\n```{r}\n#| label: setup-bins\n# Get color palette \n\nrefCol <- colorRampPalette(rev(brewer.pal(6,'Spectral')))\nmycol <- refCol(6)\n\n# define bin sizes\nbin_size <- 40\n\n# Camera resolution is 640x480. Hence...\nxbins <- 640/bin_size \nybins <- 480/bin_size\n```\n\n## ggplot2\n\nThe reason I always go to `ggplot2` first is because it's awesome, I buy into the grammar and find it intuitive to accumulate layers over layers. The underlying thought is that `ggplot2` handles all problems. In this case, the result has some pros (layers, layers and more layer), and some cons (basically, it doesn't look amazing). \n\n```{r}\n#| label: ggplot2-option-1\np <- ggplot(rat_pos, aes(X,Y)) + \n  stat_density2d(geom = 'tile', \n                 aes(fill = after_stat(density)), \n                 contour = FALSE,\n                 n = c(xbins, ybins)) +\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_gradientn(colors =  mycol) +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))\n\nprint(p)\n```\n\nThis is interesting because we can overlay things into the plot. For example the trace:\n\n```{r}\n#| label: ggplot2-option-1-trace\n\np + geom_path(alpha=0.1)\n\n```\n\n\nWe can further remove the axis (or any other modifications we feel like doing). \n\n```{r}\n#| label: ggplot2-option-1-noborder\n\np + geom_path(alpha=0.5) + theme_void()\n\n```\n\n### Helping ggplot from outside\n\nI found that, if we calculate the density externally, it looks smoother. This is a mixed, `bkde2D` mediated, `ggplot2` approach (aka the best of 2 worlds).\n\n```{r}\n#| label: ggplot2-option-2\nbins <- bkde2D(as.matrix(rat_pos[,1:2]), \n               bandwidth = c(xbins, ybins),\n               gridsize = c(640L, 480L))\n\n# reshape\nbins_to_plot <- tidyr::pivot_longer(\n  data.frame(bins$fhat) %>% tibble::rownames_to_column(), \n  cols = -rowname) %>% \n  # fix the name column\n  mutate(name = stringr::str_remove(name, \"X\")) %>% \n  # convert to numeric\n  mutate_all(as.numeric)\n\n\nggplot(bins_to_plot, aes(rowname, name, fill = value)) +\n  geom_raster()+\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_gradientn(colors =  mycol) +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n\n```\n\n### 2023 Update\n\nAs of 2023, ggplot is able to handle 2D density heatmaps much better. I haven't played too much with it, but here are some examples\n\n```{r}\nggplot(rat_pos, aes(X,Y)) + \n           stat_density_2d(geom = \"polygon\", \n                           contour = TRUE,\n                           aes(fill = after_stat(level)),\n                  bins = 8)+\n  coord_equal() +\n  scale_fill_gradientn(colors =  mycol) +\n  theme_minimal() +\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n```\n\n```{r}\nggplot(rat_pos, aes(X,Y)) + \n  geom_density_2d_filled(bins = 8)+\n  coord_equal() +\n  theme_minimal() +\n  scale_fill_brewer(palette = \"Spectral\", direction = -1)+\n  geom_vline(xintercept = c(0,640))+\n  geom_hline(yintercept = c(0,480))+\n  theme_void()\n\n```\n\n\n## Using raster package\n\nThe `raster` package is maybe an older solution, which is surprisingly low demand. In 3 lines of code we get a perfectly functional plot. On the other hand, it's not the best looking graph and we get the caveats (yes, `base` graphics).   \n\n```{r}\n#| label: raster-package\nr <- raster(xmn=0, ymn=0, xmx=640, ymx=480, res=20)\nx <- rasterize(rat_pos[,1:2], r, fun='count')\nplot(x, xlim=c(0,640), ylim=c(0,480), xaxt='n', ann=FALSE, yaxt='n')\n```\n\n\n## Documentation \n\nI have found a good amount of advice and inspiration in the links below. \n\n* http://stat405.had.co.nz/ggmap.pdf\n* https://stackoverflow.com/questions/24078774/overlay-two-ggplot2-stat-density2d-plots-with-alpha-channels?lq=1\n* https://www.r-bloggers.com/5-ways-to-do-2d-histograms-in-r/\n* https://stackoverflow.com/questions/24845652/specifying-the-scale-for-the-density-in-ggplot2s-stat-density2d\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":"html_document","warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"filters":["social-embeds","social-share"],"include-after-body":["../../footer.html"],"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","editor":"visual","comments":{"utterances":{"repo":"matiasandina/Webpage","label":"Comment","theme":"github-dark"}},"theme":{"light":"cosmo","dark":"cosmo"},"code-copy":true,"title-block-banner":true,"license":"CC BY","toc-title":"Table of contents","toc-location":"right","author":[{"name":"Matias Andina","url":"https://matiasandina.netlify.app","affiliation":"Massachusetts Institute of Technology","orcid":"0000-0002-1996-2539"}],"citation":true,"share":{"permalink":"https://matiasandina.netlify.app/","description":"Matias Andina","twitter":true,"facebook":true,"reddit":true,"stumble":true,"tumblr":false,"linkedin":true,"email":true,"mastodon":true},"title":"XY-density-maps","date":"2018-07-13","categories":["R"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}